#!/bin/bash

# –î–µ–ø–ª–æ–π —Å–∏—Å—Ç–µ–º—ã –æ—Ç–∫–ª–∏–∫–æ–≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–µ –∑–∞—è–≤–∫–∏
# –î–∞—Ç–∞: 2024

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π —Å–∏—Å—Ç–µ–º—ã –æ—Ç–∫–ª–∏–∫–æ–≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π..."

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /var/www/sviydlyasvoih/platform-svoi

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
pm2 stop sviy-platform || true

# 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub..."
git fetch origin main
git reset --hard origin/main

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

# 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
PGPASSWORD="111" psql -U postgres -d sviydlyasvoyikh -f database/migrations/add_service_request_responses.sql || true

# 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞
echo "üî® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞..."
npx prisma generate

# 6. –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üèóÔ∏è  –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
npm run build

# 7. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ PM2..."
pm2 start ecosystem.config.js

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
sleep 3
pm2 status

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìã –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:"
echo "  ‚úì –¢–∞–±–ª–∏—Ü–∞ ServiceRequestResponse –¥–ª—è –æ—Ç–∫–ª–∏–∫–æ–≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π"
echo "  ‚úì API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∫–ª–∏–∫–æ–≤ (/api/service-requests/[id]/respond)"
echo "  ‚úì API –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (/api/service-requests/[id]/select-executor)"
echo "  ‚úì –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç–∫–ª–∏–∫–∞ (ExecutorResponseCard)"
echo "  ‚úì –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥–∞—á–∏ –æ—Ç–∫–ª–∏–∫–∞ (RespondToRequestModal)"
echo "  ‚úì –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞—è–≤–∫–∏"
echo ""
echo "üéØ –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å–≤–æ–∏ —Ü–µ–Ω—ã –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–µ –∑–∞—è–≤–∫–∏!"
