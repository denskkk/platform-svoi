/**
 * Система пошуку з синонімами та пов'язаними термінами
 * Дозволяє знаходити послуги не тільки за прямим збігом, але й за спорідненими категоріями
 */

// Мапа синонімів та пов'язаних термінів
export const SEARCH_SYNONYMS: Record<string, string[]> = {
  // Будівництво і ремонт
  'сантехнік': ['прораб', 'будівельник', 'ремонт', 'майстер', 'монтаж', 'труби', 'каналізація', 'водопровід', 'опалення'],
  'електрик': ['прораб', 'будівельник', 'електромонтаж', 'проводка', 'ремонт', 'освітлення', 'майстер'],
  'прораб': ['будівельник', 'ремонт', 'будівництво', 'майстер', 'сантехнік', 'електрик', 'оздоблення'],
  'будівельник': ['прораб', 'ремонт', 'будівництво', 'майстер', 'сантехнік', 'електрик', 'цегла', 'бетон'],
  'ремонт': ['будівництво', 'прораб', 'майстер', 'оздоблення', 'сантехнік', 'електрик'],
  'майстер': ['ремонт', 'прораб', 'будівельник', 'сантехнік', 'електрик', 'послуги'],
  
  // Авто
  'автомеханік': ['сто', 'ремонт авто', 'діагностика', 'техобслуговування', 'автосервіс', 'механік'],
  'сто': ['автомеханік', 'ремонт авто', 'діагностика', 'автосервіс', 'шиномонтаж'],
  'шиномонтаж': ['сто', 'автосервіс', 'колеса', 'шини', 'балансування'],
  
  // Краса
  'перукар': ['стиліст', 'салон краси', 'зачіска', 'стрижка', 'барбер', 'краса'],
  'манікюр': ['нігті', 'педикюр', 'салон краси', 'краса', 'майстер манікюру'],
  'барбер': ['перукар', 'стиліст', 'стрижка', 'борода', 'чоловіча стрижка'],
  'косметолог': ['салон краси', 'краса', 'догляд за шкірою', 'косметологія'],
  
  // Здоров'я
  'масаж': ['масажист', 'спа', 'релакс', 'оздоровлення', 'терапія'],
  'лікар': ['медицина', 'консультація', 'діагностика', 'здоров\'я', 'клініка'],
  'стоматолог': ['зуби', 'стоматологія', 'лікування', 'протезування'],
  
  // Освіта
  'репетитор': ['навчання', 'освіта', 'викладач', 'уроки', 'курси', 'вчитель'],
  'вчитель': ['репетитор', 'освіта', 'навчання', 'викладач', 'педагог'],
  'курси': ['навчання', 'освіта', 'тренінг', 'репетитор', 'викладач'],
  
  // IT
  'програміст': ['розробник', 'веб', 'сайт', 'додаток', 'it', 'код', 'софт'],
  'веб': ['сайт', 'програміст', 'розробник', 'дизайн', 'it', 'інтернет'],
  'дизайнер': ['веб', 'графіка', 'логотип', 'брендинг', 'креатив', 'макет'],
  
  // Юридичні
  'юрист': ['адвокат', 'право', 'консультація', 'договір', 'суд', 'юридичні'],
  'бухгалтер': ['бухгалтерія', 'податки', 'звітність', 'фінанси', 'облік'],
  
  // Побутові послуги
  'прибирання': ['клінінг', 'чистка', 'прибирач', 'чисто', 'порядок', 'миття'],
  'кур\'єр': ['доставка', 'перевезення', 'логістика', 'транспорт'],
  'вантажники': ['переїзд', 'вантаж', 'перевезення', 'транспорт', 'піднімання'],
  
  // Тварини
  'ветеринар': ['ветклініка', 'тварини', 'лікування', 'собаки', 'коти', 'здоров\'я тварин'],
  'грумер': ['стрижка тварин', 'собаки', 'коти', 'догляд', 'тварини'],
  
  // Фото/відео
  'фотограф': ['фотозйомка', 'фото', 'весілля', 'портрет', 'студія', 'камера'],
  'відеограф': ['відео', 'відеозйомка', 'монтаж', 'весілля', 'зйомка'],
  
  // Їжа
  'кухар': ['кейтеринг', 'приготування', 'їжа', 'банкет', 'готування', 'меню'],
  'кондитер': ['торти', 'випічка', 'солодощі', 'десерт', 'кейк'],
}

// Категорії з ключовими словами
export const CATEGORY_KEYWORDS: Record<string, string[]> = {
  'remont': ['ремонт', 'будівництво', 'прораб', 'майстер', 'сантехнік', 'електрик', 'оздоблення', 'плитка', 'шпалери', 'фарба'],
  'auto': ['авто', 'машина', 'сто', 'механік', 'діагностика', 'шиномонтаж', 'мийка', 'полірування'],
  'krasa': ['краса', 'перукар', 'манікюр', 'педикюр', 'косметолог', 'барбер', 'стиліст', 'салон'],
  'medytsyna': ['здоров\'я', 'лікар', 'медицина', 'масаж', 'терапія', 'стоматолог', 'клініка'],
  'osvita': ['освіта', 'навчання', 'репетитор', 'курси', 'вчитель', 'викладач', 'тренінг'],
  'it': ['програміст', 'сайт', 'веб', 'розробка', 'дизайн', 'it', 'комп\'ютер', 'софт'],
  'biznes': ['юрист', 'бухгалтер', 'консультант', 'аудит', 'маркетинг', 'реклама', 'смм'],
  'pobut': ['прибирання', 'клінінг', 'кур\'єр', 'доставка', 'вантажники', 'переїзд', 'побут'],
  'tvorchist': ['фото', 'відео', 'дизайн', 'художник', 'креатив', 'декор', 'handmade'],
}

/**
 * Розширити пошуковий запит синонімами та спорідненими термінами
 */
export function expandSearchQuery(query: string): string[] {
  const lowerQuery = query.toLowerCase().trim()
  const expanded = new Set<string>([lowerQuery])
  
  // Додаємо пряме слово
  const words = lowerQuery.split(/\s+/)
  words.forEach(word => expanded.add(word))
  
  // Шукаємо синоніми для кожного слова
  words.forEach(word => {
    Object.entries(SEARCH_SYNONYMS).forEach(([key, synonyms]) => {
      if (key.includes(word) || word.includes(key)) {
        synonyms.forEach(syn => expanded.add(syn))
        expanded.add(key)
      }
    })
  })
  
  return Array.from(expanded)
}

/**
 * Отримати slug категорії за ключовими словами
 */
export function detectCategoryFromQuery(query: string): string | null {
  const lowerQuery = query.toLowerCase()
  
  for (const [categorySlug, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
    for (const keyword of keywords) {
      if (lowerQuery.includes(keyword)) {
        return categorySlug
      }
    }
  }
  
  return null
}

/**
 * Перевірити чи запит релевантний для послуги/користувача
 */
export function calculateRelevance(query: string, text: string): number {
  const expandedTerms = expandSearchQuery(query)
  const lowerText = text.toLowerCase()
  
  let score = 0
  expandedTerms.forEach(term => {
    if (lowerText.includes(term)) {
      // Пряме входження оригінального запиту дає більше балів
      score += term === query.toLowerCase() ? 3 : 1
    }
  })
  
  return score
}
