#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—é –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å –ø–ª–∞—Ç–Ω–∏—Ö –∑–∞—è–≤–æ–∫

echo "üöÄ –ü–æ—á–∏–Ω–∞—î–º–æ –¥–µ–ø–ª–æ–π –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å..."

# –ü–µ—Ä–µ—Ö—ñ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ–µ–∫—Ç—É
cd /var/www/sviydlyasvoih/platform-svoi

# –ó—É–ø–∏–Ω–∫–∞ –≤—Å—ñ—Ö PM2 –ø—Ä–æ—Ü–µ—Å—ñ–≤
echo "‚è∏Ô∏è  –ó—É–ø–∏–Ω—è—î–º–æ –≤—Å—ñ PM2 –ø—Ä–æ—Ü–µ—Å–∏..."
pm2 stop all

# –í–∏–¥–∞–ª–µ–Ω–Ω—è sviy-web —è–∫—â–æ —ñ—Å–Ω—É—î (—Ü–µ –ø–æ–º–∏–ª–∫–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å)
pm2 delete sviy-web 2>/dev/null || true

# –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É
echo "üì• –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–¥..."
git stash
git pull origin main

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
echo "üì¶ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ..."
npm install

# –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ–≥–æ –±—ñ–ª–¥—É
echo "üóëÔ∏è  –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π –±—ñ–ª–¥..."
rm -rf .next

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è Prisma Client
echo "üîß –ì–µ–Ω–µ—Ä—É—î–º–æ Prisma Client..."
npx prisma generate

# –ë—ñ–ª–¥ –ø—Ä–æ–µ–∫—Ç—É
echo "üèóÔ∏è  –ó–±–∏—Ä–∞—î–º–æ –ø—Ä–æ–µ–∫—Ç..."
npm run build

# –ó–∞–ø—É—Å–∫ –¢–Ü–õ–¨–ö–ò sviy-platform
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞—î–º–æ sviy-platform..."
pm2 start sviy-platform
pm2 save

# –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É
echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É..."
sleep 3

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
pm2 status

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤
echo ""
echo "üìã –û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏:"
pm2 logs sviy-platform --lines 30 --nostream

echo ""
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –≤—Å–µ –ø—Ä–∞—Ü—é—î: https://sviydlyasvoih.pp.ua"
