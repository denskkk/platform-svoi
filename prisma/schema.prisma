// ========================================
// СВІЙ ДЛЯ СВОЇХ - Prisma Schema
// ========================================
// Prisma ORM для Next.js інтеграції
// База даних: PostgreSQL
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  user
  business
  viewer
  admin
}

enum AccountType {
  viewer          // Глядач - тільки перегляд, базова реєстрація
  basic           // Звичайний - детальний профіль, всі функції платні
  business        // Бізнес - детальний бізнес-профіль, всі функції платні
}

enum EducationLevel {
  secondary       // Середня
  college         // Коледж
  bachelor        // Бакалавр
  master          // Магістр
  doctorate       // Аспірантура
}

enum FOPGroup {
  group1
  group2
  group3
}

enum CompanyType {
  fop             // ФОП
  tov             // ТОВ
  other           // Інше
}

enum RequestType {
  job             // Пошук роботи
  partner         // Пошук партнера (пари)
  service         // Потрібна послуга
  product         // Потрібен товар
  investor        // Пошук інвестора
  employee        // Пошук працівника
  other           // Інше
}

enum PaidActionType {
  partner_search     // Пошук пари/партнера - 5 уцмок
  job_request        // Заявка на пошук роботи - 3 уцмки
  service_request    // Заявка на послугу - 3 уцмки
  employee_search    // Пошук працівника - 4 уцмки
  investor_search    // Пошук інвестора - 5 уцмок
  advanced_search    // Розширений пошук - 2 уцмки
}

enum RequestStatus {
  active          // Активна
  in_progress     // В процесі
  completed       // Виконана
  cancelled       // Скасована
}

enum Gender {
  male
  female
  other
}

enum ReportStatus {
  new
  in_review
  resolved
  rejected
}

enum UcmTransactionKind {
  credit
  debit
}

// ========================================
// MODELS
// ========================================

model User {
  id           Int      @id @default(autoincrement()) @map("user_id")
  role         UserRole @default(user)
  accountType  AccountType @default(basic) @map("account_type")
  
  // Основна інформація
  firstName    String   @map("first_name") @db.VarChar(100)
  middleName   String?  @map("middle_name") @db.VarChar(100)
  lastName     String   @map("last_name") @db.VarChar(100)
  email        String   @unique @db.VarChar(150)
  phone        String?  @db.VarChar(30)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  
  // УЦМ (Українська Цивільна Місія)
  ucmMember    String? @map("ucm_member") @db.VarChar(50) // Участник команди УЦМ (так/ні/цікаво)
  ucmSupporter String? @map("ucm_supporter") @db.VarChar(50) // Підтримуєш проєкти УЦМ (так/ні/цікаво)
  
  // Локація
  city         String?  @db.VarChar(100)
  region       String?  @db.VarChar(100)
  housingType  String?  @map("housing_type") @db.VarChar(50) // будинок / квартира / інше
  housingDetails Json?  @map("housing_details") @default("{}") // гараж, двір, сад для будинку
  livingSituation String? @map("living_situation") @db.VarChar(100) // самостійно / з родиною
  
  // Персональна інформація
  gender       Gender?
  age          Int?
  maritalStatus String? @map("marital_status") @db.VarChar(50) // одружений / неодружений / у стосунках / розлучений / вдова
  familyComposition String? @map("family_composition") @db.Text // склад сім'ї
  childrenCount Int?    @map("children_count") // кількість дітей
  childrenAges Json?   @map("children_ages") @default("[]") // вік дітей для підбору садка/школи
  bio          String?  @db.Text
  avatarUrl    String?  @map("avatar_url") @db.VarChar(255)
  
  // Транспорт
  hasCar       Boolean? @map("has_car")
  carInfo      String?  @map("car_info") @db.VarChar(200) // марка, модель, рік
  carServices  Json?    @map("car_services") @default("{}") // СТО, мийка, автосалон
  otherTransport String? @map("other_transport") @db.VarChar(200) // велосипед / самокат
  usesTaxi     Boolean? @map("uses_taxi") // користується таксі
  hasBicycle   String?  @map("has_bicycle") @db.VarChar(50) // так/ні/плануємо
  bicycleInfo  String?  @map("bicycle_info") @db.VarChar(200) // інформація про велосипед
  
  // Професійна діяльність та освіта
  educationLevel EducationLevel? @map("education_level")
  educationDetails String? @map("education_details") @db.Text // інститут, напрямок
  profession   String?  @db.VarChar(200)
  employmentStatus String? @map("employment_status") @db.VarChar(100) // Працюю/Ні/Власник бізнесу/Сам на себе/В пошуку
  workplace    String?  @db.VarChar(255)
  privateBusinessInfo String?  @map("business_info") @db.Text // інфо про приватний бізнес
  jobSeeking   String?  @map("job_seeking") @db.Text // в якій сфері шукає роботу
  seekingPartTime Boolean? @map("seeking_part_time") // часткова зайнятість
  seekingFullTime Boolean? @map("seeking_full_time") // повноцінна робота
  seekingSpecialty String? @map("seeking_specialty") @db.VarChar(200) // спеціальність, яку шукає
  wantsStartBusiness Boolean? @map("wants_start_business") // бажання відкрити свою справу
  
  // Бізнес інформація (для extended)
  businessType String? @map("business_type") @db.VarChar(100) // ФОП/ТОВ/інше
  fopGroup     String? @map("fop_group") @db.VarChar(50) // 1/2/3 група ФОП
  tovType      String? @map("tov_type") @db.VarChar(100) // Тип ТОВ
  companyCode  String? @map("company_code") @db.VarChar(50) // ЄДРПОУ
  businessCategory String? @map("business_category") @db.VarChar(100) // Категорія бізнесу
  offerType    String? @map("offer_type") @db.VarChar(50) // послуга/товар/обидва
  
  // Історія роботи (останні 2-3 місця)
  workHistory  Json?    @map("work_history") @default("[]") // [{company, position, duration, socialLinks}]
  
  // Сімейні дані (extended)
  hasChildren  String?  @map("has_children") @db.VarChar(50) // так/ні/плануємо
  
  // Домашні тварини
  hasPets      Boolean? @map("has_pets")
  petsInfo     String?  @map("pets_info") @db.VarChar(255) // кіт/пес/сільськогосподарські/інше
  
  // Інтереси та стиль життя
  hobbies      String?  @db.Text // хобі, захоплення
  outdoorActivities String? @map("outdoor_activities") @db.Text // охота, рибалка
  lifestyle    String?  @db.Text // кафе, ресторани
  sports       String?  @db.Text // спортивна активність
  beautyServices Json?  @map("beauty_services") @default("{}") // Перукар/манікюр/СПА/масаж
  
  // Споживчі переваги
  usesDelivery String? @map("uses_delivery") @db.VarChar(50) // Користується інтернет-доставкою
  restaurantFrequency String? @map("restaurant_frequency") @db.VarChar(50) // рідко/по бажанню/часто/не хожу
  cuisinePreference String? @map("cuisine_preference") @db.VarChar(100) // Домашня/Китайська/Європейська
  usesServices Json?   @map("uses_services") @default("{}") // Електрик/Сантехнік/Клінінг/Будівельник/Садовник
  usesHomeServices Json? @map("uses_home_services") @default("[]") // масив домашніх сервісів
  
  // Бізнес-спеціалісти (для підприємців)
  usesBusinessServices Json? @map("uses_business_services") @default("{}") // Бухгалтер/Юрист/СММ/Рекламщик/Веб-спеціаліст
  readyToSwitchToUCM String? @map("ready_to_switch_ucm") @db.VarChar(50) // Готовий перейти на спеціалістів УЦМ (так/ні/цікаво)
  
  // Мета використання сайту
  siteUsageGoal Json? @map("site_usage_goal") @default("[]") // масив цілей використання платформи
  
  // Соцмережі
  socialLinks  Json?    @map("social_links") @default("{}") // Instagram, Facebook, Telegram, TikTok
  
  // Підписка (для платних акаунтів)
  subscriptionActive Boolean @default(false) @map("subscription_active")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  subscriptionStartedAt DateTime? @map("subscription_started_at")
  
  // Рейтинг
  avgRating    Decimal  @default(0.00) @map("avg_rating") @db.Decimal(3, 2)
  totalReviews Int      @default(0) @map("total_reviews")
  
  // Метадані
  isVerified   Boolean  @default(false) @map("is_verified")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  lastLogin    DateTime? @map("last_login")
  
  // Зв'язки
  services           Service[]
  businessInfo       BusinessInfo?
  requests           Request[]
  requestResponses   RequestResponse[]
  reviewsGiven       Review[]      @relation("ReviewerRelation")
  reviewsReceived    Review[]      @relation("ReviewedRelation")
  messagesSent       Message[]     @relation("SentMessages")
  messagesReceived   Message[]     @relation("ReceivedMessages")
  conversationsAsUser1 Conversation[] @relation("ConversationUser1")
  conversationsAsUser2 Conversation[] @relation("ConversationUser2")
  favorites          Favorite[]    @relation("UserFavorites")
  favoritedBy        Favorite[]    @relation("TargetUser")
  reportsCreated     Report[]      @relation("Reporter")
  reportsReceived    Report[]      @relation("ReportedUser")
  notifications      Notification[]
  sessions           Session[]
  searchLogs         SearchLog[]
  subscriptions      Subscription[]
  payments           Payment[]
  balanceUcm         Decimal  @default(0.00) @map("balance_ucm") @db.Decimal(12, 2) // Баланс у внутрішній валюті «уцмка»
  // Реферали та транзакції уцмок
  referralCode       String?  @unique @map("referral_code") @db.VarChar(50)
  referredById       Int?     @map("referred_by_id")
  referredBy         User?    @relation("ReferredBy", fields: [referredById], references: [id], onDelete: SetNull)
  ucmTransactions    UcmTransaction[]
  paidActions        PaidAction[]
  referralsInvited   User[]   @relation("ReferredBy")
  referralsAsInviter Referral[] @relation("RefInviter")
  referralsAsInvitee Referral[] @relation("RefInvitee")
  
  @@index([email])
  @@index([city])
  @@index([role])
  @@index([accountType])
  @@index([employmentStatus])
  @@index([subscriptionActive])
  @@index([createdAt])
  @@map("users")
}

model Category {
  id          Int       @id @default(autoincrement()) @map("category_id")
  name        String    @unique @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  iconUrl     String?   @map("icon_url") @db.VarChar(255)
  emoji       String?   @db.VarChar(10)
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  // Зв'язки
  services    Service[]
  searchLogs  SearchLog[]
  
  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model Service {
  id          Int      @id @default(autoincrement()) @map("service_id")
  userId      Int      @map("user_id")
  categoryId  Int      @map("category_id")
  
  // Основна інформація
  title       String   @db.VarChar(150)
  description String   @db.Text
  
  // Зображення
  imageUrl    String?  @map("image_url") @db.VarChar(500)
  images      Json?    @default("[]")
  
  // Ціна
  priceFrom   Decimal? @map("price_from") @db.Decimal(10, 2)
  priceTo     Decimal? @map("price_to") @db.Decimal(10, 2)
  priceUnit   String?  @map("price_unit") @db.VarChar(50)
  
  // Локація
  city        String?  @db.VarChar(100)
  region      String?  @db.VarChar(100)
  address     String?  @db.VarChar(255)
  
  // Статус
  isActive    Boolean  @default(true) @map("is_active")
  viewsCount  Int      @default(0) @map("views_count")
  
  // Метадані
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Зв'язки
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id])
  
  @@index([userId])
  @@index([categoryId])
  @@index([city])
  @@index([isActive])
  @@index([createdAt(sort: Desc)])
  @@index([priceFrom])
  @@index([title]) // Для швидкого пошуку за назвою
  @@index([city, categoryId]) // Композитний індекс для фільтрації
  @@index([isActive, createdAt(sort: Desc)]) // Для головної сторінки
  @@map("services")
}

model BusinessInfo {
  id            Int      @id @default(autoincrement()) @map("business_id")
  userId        Int      @unique @map("user_id")
  
  // Основна інформація
  companyName   String   @map("company_name") @db.VarChar(200)
  companyCode   String?  @map("company_code") @db.VarChar(50) // Код ЄДРПОУ
  representativeName String? @map("representative_name") @db.VarChar(200) // ПІБ представника
  position      String?  @db.VarChar(100) // Посада (власник / менеджер)
  city          String?  @db.VarChar(100) // Місто діяльності
  region        String?  @db.VarChar(100) // Регіон діяльності
  businessType  String?  @map("business_type") @db.VarChar(200) // Тип бізнесу / сфера
  businessCategory String? @map("business_category") @db.VarChar(100) // Освіта/Продукти/Реклама/Інтернет-продажі/СТО
  
  // Тип компанії
  companyType   CompanyType? @map("company_type")
  fopGroup      FOPGroup?    @map("fop_group") // Для ФОП - група (1/2/3)
  
  // Що продаєте/покупаєте
  offerType     String?  @map("offer_type") @db.VarChar(50) // Послуга/Товар
  
  logoUrl       String?  @map("logo_url") @db.VarChar(255)
  
  // Короткий опис
  description   String?  @db.Text // Що пропонуєте
  mission       String?  @db.Text // Основна місія / цінність
  uniqueValue   String?  @map("unique_value") @db.Text // Чим відрізняєтесь
  
  // Послуги та товари
  servicesList  String?  @map("services_list") @db.Text // Список послуг
  priceRange    String?  @map("price_range") @db.VarChar(100) // мінімальна/середня/преміум
  workHours     String?  @map("work_hours") @db.VarChar(200) // Графік роботи
  serviceLocation String? @map("service_location") @db.VarChar(255) // Адреса або онлайн
  address       String?  @db.VarChar(255)
  
  // Команда
  employeeCount String?  @map("employee_count") @db.VarChar(50)
  keySpecialists String? @map("key_specialists") @db.Text // Ключові спеціалісти
  teamDescription String? @map("team_description") @db.Text // Опис команди
  
  // Контакти
  phone         String?  @db.VarChar(30)
  viber         String?  @db.VarChar(100)
  telegram      String?  @db.VarChar(100)
  email         String?  @db.VarChar(150)
  website       String?  @db.VarChar(255)
  
  // Соцмережі (JSON)
  socialLinks   Json     @default("{}") @map("social_links") // Instagram, Facebook, TikTok, YouTube, LinkedIn
  
  // Візуальні матеріали (JSON)
  gallery       Json     @default("[]") // Фото робіт / послуг / офісу
  videoUrl      String?  @map("video_url") @db.VarChar(255) // Відео-презентація
  
  // Відгуки (зовнішні посилання)
  externalReviews Json?  @map("external_reviews") @default("{}") // Google, Facebook links
  
  // Пошук (для Бізнес акаунтів)
  seekingPartner   Boolean @default(false) @map("seeking_partner")
  seekingInvestor  Boolean @default(false) @map("seeking_investor")
  seekingCustomer  Boolean @default(false) @map("seeking_customer")
  seekingEmployee  Boolean @default(false) @map("seeking_employee")
  
  seekingCriteria  Json?   @map("seeking_criteria") @default("{}") // Критерії пошуку
  
  // Детальні пошуки
  partnerSearchDetails Json? @map("partner_search_details") @default("{}") // Деталі пошуку партнера: тип, сфера, умови співпраці
  investorSearchDetails Json? @map("investor_search_details") @default("{}") // Деталі пошуку інвестора: сума, строк, цілі інвестицій, що пропонується
  customerSearchDetails Json? @map("customer_search_details") @default("{}") // Деталі пошуку споживачів: цільова аудиторія, що пропонується
  employeeVacancies Json? @map("employee_vacancies") @default("[]") // Вакансії: [{посада, обов'язки, вимоги, зарплата, тип_зайнятості, досвід}]
  
  // Візуальні матеріали компанії
  bannerUrl     String? @map("banner_url") @db.VarChar(255) // Банер компанії
  
  // Преміум функції (тільки для business_premium)
  offerToCustomers Boolean @default(false) @map("offer_to_customers") // Пропонувати споживачам
  offerToPartners  Boolean @default(false) @map("offer_to_partners") // Пропонувати партнерам
  offerToInvestors Boolean @default(false) @map("offer_to_investors") // Пропонувати інвесторам
  wantsUCMAnalysis Boolean @default(false) @map("wants_ucm_analysis") // Потребує аналізу від УЦМ
  
  // Додаткова інформація
  yearFounded   Int?     @map("year_founded")
  registrationType String? @map("registration_type") @db.VarChar(50) // ФОП / ТОВ
  hasCertificates Boolean? @map("has_certificates") // Наявність сертифікатів
  certificatesInfo String? @map("certificates_info") @db.Text // Опис сертифікатів
  partners      String?  @db.Text // Партнери або членство
  
  // Метадані
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Зв'язки
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([city])
  @@index([businessType])
  @@index([businessCategory])
  @@index([companyType])
  @@map("business_info")
}

model Review {
  id         Int      @id @default(autoincrement()) @map("review_id")
  reviewerId Int      @map("reviewer_id")
  reviewedId Int      @map("reviewed_id")
  
  // Оцінка
  rating     Int
  comment    String?  @db.Text
  photos     Json     @default("[]")
  
  // Метадані
  isVisible  Boolean  @default(true) @map("is_visible")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  
  // Зв'язки
  reviewer   User     @relation("ReviewerRelation", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewed   User     @relation("ReviewedRelation", fields: [reviewedId], references: [id], onDelete: Cascade)
  
  @@unique([reviewerId, reviewedId])
  @@index([reviewerId])
  @@index([reviewedId])
  @@index([rating])
  @@index([createdAt(sort: Desc)])
  @@map("reviews")
}

model Favorite {
  id           Int      @id @default(autoincrement()) @map("favorite_id")
  userId       Int      @map("user_id")
  targetUserId Int      @map("target_user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Зв'язки
  user         User     @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  targetUser   User     @relation("TargetUser", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  @@unique([userId, targetUserId])
  @@index([userId])
  @@index([targetUserId])
  @@map("favorites")
}

model Report {
  id             Int          @id @default(autoincrement()) @map("report_id")
  reporterId     Int          @map("reporter_id")
  reportedUserId Int          @map("reported_user_id")
  
  // Деталі
  reason         String       @db.Text
  category       String?      @db.VarChar(100)
  
  // Статус
  status         ReportStatus @default(new)
  adminComment   String?      @map("admin_comment") @db.Text
  adminId        Int?         @map("admin_id")
  
  // Метадані
  createdAt      DateTime     @default(now()) @map("created_at")
  resolvedAt     DateTime?    @map("resolved_at")
  
  // Зв'язки
  reporter       User         @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser   User         @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  
  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

model Notification {
  id                Int      @id @default(autoincrement()) @map("notification_id")
  userId            Int      @map("user_id")
  
  // Контент
  type              String   @db.VarChar(50)
  title             String   @db.VarChar(200)
  message           String?  @db.Text
  
  // Пов'язані дані
  relatedUserId     Int?     @map("related_user_id")
  relatedEntityType String?  @map("related_entity_type") @db.VarChar(50)
  relatedEntityId   Int?     @map("related_entity_id")
  
  // Статус
  isRead            Boolean  @default(false) @map("is_read")
  
  // Метадані
  createdAt         DateTime @default(now()) @map("created_at")
  readAt            DateTime? @map("read_at")
  
  // Зв'язки
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

model Session {
  id               String   @id @default(uuid()) @map("session_id") @db.Uuid
  userId           Int      @map("user_id")
  
  // Токени
  tokenHash        String   @unique @map("token_hash") @db.VarChar(255)
  refreshTokenHash String?  @map("refresh_token_hash") @db.VarChar(255)
  
  // Метадані пристрою
  userAgent        String?  @map("user_agent") @db.Text
  ipAddress        String?  @map("ip_address") @db.VarChar(45)
  
  // Час життя
  createdAt        DateTime @default(now()) @map("created_at")
  expiresAt        DateTime @map("expires_at")
  lastActivity     DateTime @default(now()) @map("last_activity")
  
  // Статус
  isActive         Boolean  @default(true) @map("is_active")
  
  // Зв'язки
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([isActive])
  @@map("sessions")
}

model SearchLog {
  id           Int       @id @default(autoincrement()) @map("search_id")
  userId       Int?      @map("user_id")
  
  // Параметри пошуку
  query        String?   @db.Text
  categoryId   Int?      @map("category_id")
  city         String?   @db.VarChar(100)
  
  // Результати
  resultsCount Int       @default(0) @map("results_count")
  
  // Метадані
  createdAt    DateTime  @default(now()) @map("created_at")
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  
  // Зв'язки
  user         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  category     Category? @relation(fields: [categoryId], references: [id])
  
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([query])
  @@map("search_logs")
}

model Request {
  id            Int           @id @default(autoincrement()) @map("request_id")
  userId        Int           @map("user_id")
  
  // Тип та статус
  type          RequestType
  status        RequestStatus @default(active)
  
  // Деталі заявки
  title         String        @db.VarChar(200)
  description   String        @db.Text
  
  // Локація
  city          String?       @db.VarChar(100)
  region        String?       @db.VarChar(100)
  
  // Категорія (для послуг/товарів)
  categoryId    Int?          @map("category_id")
  
  // Бюджет
  budgetFrom    Decimal?      @map("budget_from") @db.Decimal(10, 2)
  budgetTo      Decimal?      @map("budget_to") @db.Decimal(10, 2)
  
  // Терміни
  deadlineAt    DateTime?     @map("deadline_at")
  
  // Додаткові критерії (JSON)
  criteria      Json?         @default("{}")
  
  // Статистика
  viewsCount    Int           @default(0) @map("views_count")
  responsesCount Int          @default(0) @map("responses_count")
  
  // Метадані
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  completedAt   DateTime?     @map("completed_at")
  // Платні опції
  isPaid        Boolean       @default(false) @map("is_paid")
  priceUcm      Decimal?      @map("price_ucm") @db.Decimal(12, 2)
  promoted      Boolean       @default(false) @map("promoted")
  expiresAt     DateTime?     @map("expires_at")
  metadata      Json?         @default("{}")
  
  // Зв'язки
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  responses     RequestResponse[]
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([city])
  @@index([categoryId])
  @@index([createdAt(sort: Desc)])
  @@map("requests")
}

model RequestResponse {
  id            Int      @id @default(autoincrement()) @map("response_id")
  requestId     Int      @map("request_id")
  userId        Int      @map("user_id")
  
  // Відповідь
  message       String   @db.Text
  price         Decimal? @db.Decimal(10, 2)
  timeframe     String?  @db.VarChar(100) // Терміни виконання
  
  // Статус
  isAccepted    Boolean  @default(false) @map("is_accepted")
  isViewed      Boolean  @default(false) @map("is_viewed")
  
  // Метадані
  createdAt     DateTime @default(now()) @map("created_at")
  viewedAt      DateTime? @map("viewed_at")
  
  // Зв'язки
  request       Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([requestId])
  @@index([userId])
  @@index([isAccepted])
  @@index([createdAt(sort: Desc)])
  @@map("request_responses")
}

model Subscription {
  id            Int      @id @default(autoincrement()) @map("subscription_id")
  userId        Int      @map("user_id")
  
  // Тип та статус
  accountType   AccountType
  isActive      Boolean  @default(true) @map("is_active")
  
  // Період
  startedAt     DateTime @default(now()) @map("started_at")
  expiresAt     DateTime @map("expires_at")
  
  // Оплата
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("UAH") @db.VarChar(10)
  paymentMethod String?  @map("payment_method") @db.VarChar(50)
  transactionId String?  @map("transaction_id") @db.VarChar(100)
  
  // Метадані
  createdAt     DateTime @default(now()) @map("created_at")
  cancelledAt   DateTime? @map("cancelled_at")
  
  // Зв'язки
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([accountType])
  @@index([isActive])
  @@index([expiresAt])
  @@map("subscriptions")
}

model City {
  id            Int     @id @default(autoincrement()) @map("city_id")
  name          String  @unique @db.VarChar(100)
  nameEn        String? @map("name_en") @db.VarChar(100)
  region        String? @db.VarChar(100)
  
  // Координати
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  
  // Статистика
  usersCount    Int     @default(0) @map("users_count")
  servicesCount Int     @default(0) @map("services_count")
  
  isActive      Boolean @default(true) @map("is_active")
  
  @@index([name])
  @@index([region])
  @@map("cities")
}

// ========================================
// MESSAGING SYSTEM (Система сообщений)
// ========================================

model Conversation {
  id              Int       @id @default(autoincrement()) @map("conversation_id")
  
  // Участники (2 пользователя)
  user1Id         Int       @map("user1_id")
  user2Id         Int       @map("user2_id")
  user1           User      @relation("ConversationUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2           User      @relation("ConversationUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  
  // Сообщения
  messages        Message[]
  
  // Метаданные
  lastMessageAt   DateTime? @map("last_message_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@index([lastMessageAt])
  @@map("conversations")
}

model Message {
  id              Int          @id @default(autoincrement()) @map("message_id")
  conversationId  Int          @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Отправитель
  senderId        Int          @map("sender_id")
  sender          User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  
  // Получатель
  receiverId      Int          @map("receiver_id")
  receiver        User         @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  // Содержимое
  content         String       @db.Text
  
  // Статус
  isRead          Boolean      @default(false) @map("is_read")
  readAt          DateTime?    @map("read_at")
  
  // Метаданные
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  
  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([createdAt])
  @@map("messages")
}

// ========================================
// PAYMENTS (WayForPay)
// ========================================

model Payment {
  id              Int       @id @default(autoincrement()) @map("payment_id")
  userId          Int       @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider        String    @default("wayforpay") @db.VarChar(50)
  orderReference  String    @unique @map("order_reference") @db.VarChar(100)
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @default("UAH") @db.VarChar(10)
  description     String?   @db.Text
  status          String    @default("new") @db.VarChar(30)
  invoiceUrl      String?   @map("invoice_url") @db.VarChar(255)
  rawRequest      Json?     @map("raw_request")
  rawResponse     Json?     @map("raw_response")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("payments")
}

// ========================================
// UCM TRANSACTIONS (ledger)
// ========================================

model UcmTransaction {
  id                Int                 @id @default(autoincrement()) @map("tx_id")
  userId            Int                 @map("user_id")
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  kind              UcmTransactionKind  @map("kind")
  amount            Decimal             @db.Decimal(12, 2)
  reason            String              @db.VarChar(50) // referral_inviter | referral_invitee | request_partner | topup | refund
  relatedEntityType String?             @map("related_entity_type") @db.VarChar(50)
  relatedEntityId   Int?                @map("related_entity_id")
  meta              Json?               @default("{}")
  createdAt         DateTime            @default(now()) @map("created_at")

  @@index([userId, createdAt(sort: Desc)])
  @@index([reason])
  @@map("ucm_transactions")
}

// ========================================
// PAID ACTIONS (Платні дії користувачів)
// ========================================

model PaidAction {
  id                Int              @id @default(autoincrement()) @map("paid_action_id")
  userId            Int              @map("user_id")
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  actionType        PaidActionType   @map("action_type")
  amount            Decimal          @db.Decimal(12, 2) // Сума списання
  relatedEntityType String?          @map("related_entity_type") @db.VarChar(50) // Request, Search тощо
  relatedEntityId   Int?             @map("related_entity_id")
  description       String?          @db.Text
  success           Boolean          @default(true) // Чи успішно виконано дію
  errorMessage      String?          @map("error_message") @db.Text
  createdAt         DateTime         @default(now()) @map("created_at")

  @@index([userId, createdAt(sort: Desc)])
  @@index([actionType])
  @@map("paid_actions")
}

// ========================================
// REFERRALS
// ========================================

model Referral {
  id            Int      @id @default(autoincrement()) @map("referral_id")
  code          String   @db.VarChar(50)
  inviterId     Int      @map("inviter_id")
  inviteeId     Int      @unique @map("invitee_id")
  inviter       User     @relation("RefInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee       User     @relation("RefInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)
  bonusInviter  Decimal  @map("bonus_inviter") @db.Decimal(12, 2)
  bonusInvitee  Decimal  @map("bonus_invitee") @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([code])
  @@index([inviterId])
  @@map("referrals")
}
